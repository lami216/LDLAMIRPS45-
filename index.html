<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>لعبة حجرة ورقة مقص</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      font-family: Arial, sans-serif;direction:rtl;background:linear-gradient(135deg,#e0eafc,#cfdef3);
      margin:0;padding:0;overflow-x:hidden
    }
    /* شريط التحكم */
    #controls{
      padding:10px;background:#2c3e50;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,.2);
      position:relative; z-index:5; display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap;
    }
    .btn{
      padding:10px 14px;font-size:14px;cursor:pointer;border:0;border-radius:8px;
      background:#3498db;color:#fff;font-weight:bold;transition:.25s
    }
    .btn:hover{background:#2980b9;transform:scale(1.04)}
    .btn-green{background:#27ae60}.btn-green:hover{background:#1e8f4c}
    .btn-danger{background:#e74c3c}.btn-danger:hover{background:#c0392b}
    .btn-warning{background:#f39c12}.btn-warning:hover{background:#d68910}
    .input{
      padding:9px 10px;border-radius:8px;border:0;font-weight:bold;width:80px;text-align:center
    }
    /* قائمة السرعة المنبثقة – تُتموضع برمجيًا بجانب الزر */
    .menu{
      position:absolute;background:#1f2a36;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,.25);display:none; z-index:20;
      min-width:120px
    }
    .menu button{display:block;width:100%;text-align:right;background:transparent;border:0;color:#fff;padding:10px 12px;cursor:pointer}
    .menu button:hover{background:#2c3e50}

    /* شريط الإحصاءات + الهدية (خارج الحلبة) */
    #stats{
      padding:8px 12px;background:#34495e;color:#fff;display:flex;gap:18px;align-items:center;justify-content:center;
      font-size:18px;font-weight:bold;border-bottom:3px solid #2c3e50; position:relative; z-index:4; flex-wrap:wrap
    }
    #stats .item{display:flex;align-items:center;gap:6px}
    #goalBox{
      background:#ff8a00;color:#fff;border-radius:12px;padding:6px 10px;display:flex;align-items:center;gap:8px;
      box-shadow:0 6px 16px rgba(0,0,0,.25);font-weight:bold
    }
    #goalBox .gift{font-size:20px}
    #goalBox .pct{background:#fff;color:#ff8a00;font-weight:900;border-radius:8px;padding:4px 8px;min-width:48px;text-align:center}

    /* الحلبة */
    #arena{
      width:100%;height:600px;background:#fff;position:relative;overflow:hidden;border:3px solid #2c3e50;border-radius:12px;margin-top:10px
    }
    .entity{
      position:absolute;font-size:20px;width:24px;height:24px;text-align:center;user-select:none;will-change:left,top,transform
    }

    /* شاشة الفائز */
    #winnerScreen{
      position:absolute;inset:0;background:rgba(255,255,255,.9);display:flex;flex-direction:column;justify-content:center;align-items:center;
      z-index:100;opacity:0;transition:opacity .8s ease;pointer-events:none
    }
    #winnerScreen.show{opacity:1}
    #winnerEmoji{font-size:120px;animation:pulse 1s infinite alternate;position:relative;z-index:150}
    #winnerText{font-size:36px;font-weight:bold;margin-top:10px;color:#2c3e50;position:relative;z-index:150}
    @keyframes pulse{from{transform:scale(1)}to{transform:scale(1.15)}}

    /* الكونفيتي داخل الحلبة فقط */
    .confetti{position:absolute;width:10px;height:10px;opacity:.95;z-index:200;border-radius:2px}

    /* توقيع الصورة أسفل اللعبة */
    #signatureWrap{display:flex;justify-content:center;align-items:center;margin:14px 0 24px}
    #signatureWrap img{max-width:92%;height:auto;opacity:.95}
  </style>

  <!-- Google tag (gtag.js) - GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XTSXTQT484"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XTSXTQT484');

    // دالة مساعدة للتتبّع
    function track(eventName, params){ try{ gtag('event', eventName, params||{}); }catch(e){} }
  </script>
</head>
<body>

  <div id="controls">
    <button id="startBtn" class="btn btn-green">بدء ▶️</button>
    <button id="endBtn" class="btn btn-danger">إنهاء ⛔</button>

    <!-- عدد العناصر لكل نوع (افتراضي 12) -->
    <label style="color:#fff;">العدد/نوع:
      <input id="countInput" class="input" type="number" min="1" max="36" value="12">
    </label>

    <!-- زر السرعة بقائمة تظهر بجواره -->
    <button id="speedBtn" class="btn btn-warning">⚡ السرعة: <span id="speedLabel">1.5x</span></button>
    <div id="speedMenu" class="menu">
      <button data-speed="1">1x</button>
      <button data-speed="1.5">1.5x</button>
      <button data-speed="2">2x</button>
      <button data-speed="3">3x</button>
    </div>
  </div>

  <div id="stats">
    <div id="goalBox"><span class="gift">🎁</span><span>الحظ المتواصل</span><span id="goalPct" class="pct">0%</span></div>
    <div class="item">🪨 <span id="rockCount">0</span></div>
    <div class="item">✂️ <span id="scissorsCount">0</span></div>
    <div class="item">📄 <span id="paperCount">0</span></div>
    <div class="item">🏆 <span id="lastWinner">-</span></div>
  </div>

  <div id="arena">
    <div id="winnerScreen">
      <div id="winnerEmoji"></div>
      <div id="winnerText">🏆 البطل 🏆</div>
    </div>
  </div>

  <!-- صورة التوقيع أسفل الحلبة -->
  <div id="signatureWrap">
    <img src="Signature.png" alt="Signature">
  </div>

  <!-- صوت الفوز -->
  <audio id="victorySound" src="https://www.fesliyanstudios.com/play-mp3/387" preload="auto"></audio>

<script>
  const controls = document.getElementById("controls");
  const arena = document.getElementById("arena");
  const lastWinner = document.getElementById("lastWinner");
  const winnerScreen = document.getElementById("winnerScreen");
  const winnerEmoji = document.getElementById("winnerEmoji");
  const victorySound = document.getElementById("victorySound");
  const goalPctEl = document.getElementById("goalPct");

  const startBtn = document.getElementById("startBtn");
  const endBtn = document.getElementById("endBtn");
  const countInput = document.getElementById("countInput");

  const speedBtn = document.getElementById("speedBtn");
  const speedMenu = document.getElementById("speedMenu");
  const speedLabel = document.getElementById("speedLabel");

  // السرعة
  let speedFactor = 1.5;

  // حالة اللعبة
  let gameRunning = false;
  let animationFrameId;

  // الكيانات
  const emojis = { rock:"🪨", paper:"📄", scissors:"✂️" };
  const beatMap = { rock:"scissors", scissors:"paper", paper:"rock" };
  let counts = { rock:0, paper:0, scissors:0 };
  let entities = [];

  // الصوتيات (ملفاتك المحلية بجانب index.html)
  const soundURLs = {
    rock: "Rock.mp3",
    paper: "Paper.mp3",
    scissors: "scissor.mp3"
  };

  // لتوقيف كل أصوات التصادم فور إعلان الفائز
  const activeSFX = new Set();
  function stopAllSFX(){
    activeSFX.forEach(a => { try{ a.pause(); a.currentTime = 0; }catch(_){}} );
    activeSFX.clear();
  }

  // تشغيل صوت التصادم = صوت النوع الفائز فقط (لا صوت عندما النوعان متطابقان)
  function playHit(type){
    if(!gameRunning) return; // احتياط
    const url = soundURLs[type];
    if(!url) return;
    try{
      const a = new Audio(url);
      a.volume = 0.75;
      a.playbackRate = speedFactor; // مزامنة الصوت مع سرعة اللعبة
      activeSFX.add(a);
      a.addEventListener('ended', ()=> activeSFX.delete(a));
      a.play().catch(()=>{ activeSFX.delete(a); });
    }catch(_){}
  }

  // هدف: تتبّع فوز نفس النوع على التوالي
  let lastRoundWinner = null;
  let winnerStreak = 0; // 0..10

  function updateGoalUI(){
    const pct = Math.min(winnerStreak,10)*10;
    goalPctEl.textContent = pct + "%";
  }

  function announceJackpot(){
    track('jackpot_reached', { code: '41380130', streak: 10 });
    alert("🎁 الكود: 41380130\nلقد فزت معنا بجائزة قدرها 1000 أوقية مقدمة من المطور على روعة حظك!");
  }

  // قائمة السرعة: تموضع بجوار الزر
  speedBtn.addEventListener("click", () => {
    const btnRect = speedBtn.getBoundingClientRect();
    const ctrlRect = controls.getBoundingClientRect();
    speedMenu.style.left = (btnRect.left - ctrlRect.left) + "px";
    speedMenu.style.top  = (btnRect.bottom - ctrlRect.top + 6) + "px";
    speedMenu.style.display = (speedMenu.style.display === "block" ? "none" : "block");
  });
  document.addEventListener("click",(e)=>{
    if(!speedBtn.contains(e.target) && !speedMenu.contains(e.target)){
      speedMenu.style.display="none";
    }
  });
  // تتبّع تغيّر السرعة
  speedMenu.querySelectorAll("button").forEach(btn=>{
    btn.onclick = ()=>{
      speedFactor = parseFloat(btn.dataset.speed);
      speedLabel.textContent = btn.textContent;
      speedMenu.style.display="none";
      track('speed_change', { speed: speedFactor });
    };
  });

  // تتبّع تغيّر عدد العناصر/نوع
  countInput.addEventListener('change', function(){
    // clamp للسقف الجديد 36
    if(this.value > 36) this.value = 36;
    const v = Number(this.value || 12);
    track('count_per_type_changed', { count_per_type: v });
  });

  function getRandomPosition(){
    return {
      x: Math.random() * (arena.clientWidth - 24),
      y: Math.random() * (arena.clientHeight - 24)
    };
  }

  function createEntity(type){
    const div = document.createElement("div");
    div.className = "entity";
    div.dataset.type = type;
    div.textContent = emojis[type];

    const {x,y} = getRandomPosition();
    div.style.left = x+"px";
    div.style.top = y+"px";
    arena.appendChild(div);

    let baseDx = (Math.random()*2 - 1) || 0.6;
    let baseDy = (Math.random()*2 - 1) || -0.6;

    entities.push({ el:div, x, y, baseDx, baseDy });
    counts[type]++;
  }

  function updateCounts(){
    document.getElementById("rockCount").textContent = counts.rock;
    document.getElementById("paperCount").textContent = counts.paper;
    document.getElementById("scissorsCount").textContent = counts.scissors;
  }

  function rectOf(e){ return e.el.getBoundingClientRect(); }
  function checkCollision(a,b){
    const r1 = rectOf(a), r2 = rectOf(b);
    return !(r1.right<r2.left || r1.left>r2.right || r1.bottom<r2.top || r1.top>r2.bottom);
  }

  // دفعة متعاكسة على خط التصادم
  function knockback(a,b){
    const ax=a.x+12, ay=a.y+12, bx=b.x+12, by=b.y+12;
    let nx=ax-bx, ny=ay-by; const len=Math.hypot(nx,ny)||1; nx/=len; ny/=len;
    const base=1.2*speedFactor, jitter=0.25;
    a.baseDx =  nx*base + (Math.random()*jitter - jitter/2);
    a.baseDy =  ny*base + (Math.random()*jitter - jitter/2);
    b.baseDx = -nx*base + (Math.random()*jitter - jitter/2);
    b.baseDy = -ny*base + (Math.random()*jitter - jitter/2);
    const sep=3; a.x+=nx*sep; a.y+=ny*sep; b.x-=nx*sep; b.y-=ny*sep;
  }

  function rpsResolve(a,b){
    let aType=a.el.dataset.type, bType=b.el.dataset.type;

    if(aType===bType){
      // لا صوت عند تطابق النوعين
      return;
    }
    if(beatMap[aType]===bType){
      counts[bType]--; b.el.dataset.type=aType; b.el.textContent=emojis[aType];
      counts[aType]++; updateCounts(); playHit(aType);
    }else if(beatMap[bType]===aType){
      counts[aType]--; a.el.dataset.type=bType; a.el.textContent=emojis[bType];
      counts[bType]++; updateCounts(); playHit(bType);
    }
  }

  function animate(){
    if(!gameRunning) return;

    // حركة
    entities.forEach(e=>{
      let dx=e.baseDx*speedFactor, dy=e.baseDy*speedFactor;
      e.x+=dx; e.y+=dy;
      if(e.x<=0 || e.x>=arena.clientWidth-24){ e.baseDx*=-1; e.x=Math.min(Math.max(e.x,0),arena.clientWidth-24); }
      if(e.y<=0 || e.y>=arena.clientHeight-24){ e.baseDy*=-1; e.y=Math.min(Math.max(e.y,0),arena.clientHeight-24); }
      e.el.style.left=e.x+"px"; e.el.style.top=e.y+"px";
    });

    // التصادمات
    for(let i=0;i<entities.length;i++){
      for(let j=i+1;j<entities.length;j++){
        const a=entities[i], b=entities[j];
        if(checkCollision(a,b)){
          knockback(a,b);
          rpsResolve(a,b);
        }
      }
    }

    // تحقق فائز الجولة
    const aliveTypes = Object.keys(counts).filter(t=>counts[t]>0);
    if(aliveTypes.length===1){
      gameRunning=false; 
      cancelAnimationFrame(animationFrameId);

      const winnerType = aliveTypes[0];

      // إعادة ضبط/زيادة الهدف بحسب الفائز
      if(lastRoundWinner===winnerType){ 
        winnerStreak++; 
      } else { 
        winnerStreak = 1;  // يبدأ من 1 للفائز الجديد
      }
      lastRoundWinner = winnerType; 
      updateGoalUI();
      if(winnerStreak===10){ announceJackpot(); }

      showWinner(winnerType);
      return;
    }

    animationFrameId = requestAnimationFrame(animate);
  }

  // كونفيتي داخل الحلبة فقط ويقف عند القاع
  function spawnConfettiOverWinner(){
    const hostRect = winnerEmoji.getBoundingClientRect();
    const arenaRect = arena.getBoundingClientRect();
    const originX = (hostRect.left + hostRect.right)/2 - arenaRect.left;
    const originTop = (hostRect.top - arenaRect.top) + 10;
    const colors=["#e74c3c","#2ecc71","#3498db","#f1c40f","#9b59b6"];
    for(let i=0;i<60;i++){
      const c=document.createElement("div");
      c.className="confetti";
      c.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
      const startX=originX-80+Math.random()*160;
      const startY=Math.max(0, originTop-40+Math.random()*20);
      c.style.left=startX+"px"; c.style.top=startY+"px";
      arena.appendChild(c);
      let vy=2+Math.random()*2, vx=(Math.random()-0.5)*1.2, rot=(Math.random()<0.5?-1:1)*(1+Math.random()*2), ang=0;
      const fall=setInterval(()=>{
        let y=parseFloat(c.style.top), x=parseFloat(c.style.left);
        y+=vy; x+=vx; ang+=rot;
        c.style.top=y+"px"; c.style.left=x+"px"; c.style.transform=`rotate(${ang}deg)`;
        if(y>=arena.clientHeight-12){ c.style.top=(arena.clientHeight-12)+"px"; clearInterval(fall); }
      },16);
      setTimeout(()=>{ try{c.remove()}catch(_){}} , 8000);
    }
  }

  function showWinner(type){
    // اقطع فورًا أي أصوات تصادم شغالة
    stopAllSFX();

    track('round_winner', {
      winner: type,
      rock_left: counts.rock,
      paper_left: counts.paper,
      scissors_left: counts.scissors
    });

    entities.forEach(e=> e.el.style.opacity="0");
    setTimeout(()=>{
      winnerEmoji.textContent = {rock:"🪨",paper:"📄",scissors:"✂️"}[type];
      winnerScreen.classList.add("show");
      lastWinner.textContent = type==="rock"?"حجر":type==="paper"?"ورقة":"مقص";
      try{ 
        victorySound.pause(); 
        victorySound.currentTime=0; 
        victorySound.play().catch(()=>{}); 
      }catch(_){}
      spawnConfettiOverWinner();
    },400);
  }

  function clearArena(){
    stopAllSFX(); // تنظيف أي صوت عند تصفية الحلبة أيضًا
    arena.querySelectorAll(".entity").forEach(el=>el.remove());
    arena.querySelectorAll(".confetti").forEach(c=>c.remove());
    entities=[]; counts={rock:0,paper:0,scissors:0};
    updateCounts(); winnerScreen.classList.remove("show");
    winnerEmoji.textContent=""; lastWinner.textContent="-";
  }

  function startGame(){
    if(gameRunning) return;
    clearArena();

    // توزيع بعدد مخصّص لكل نوع (افتراضي 12، سقف 36)
    const perType = Math.max(1, Math.min(36, parseInt(countInput.value || "12",10)));
    countInput.value = perType; // تثبيت ضمن النطاق
    ["rock","paper","scissors"].forEach(t=>{
      for(let i=0;i<perType;i++) createEntity(t);
    });
    updateCounts();

    gameRunning=true; 
    track('start_game', { ui:'button', per_type_default: perType });
    track('game_round_started', { per_type: perType, total_spawned: perType*3 });

    animate();
  }

  function endGame(){
    gameRunning=false; 
    cancelAnimationFrame(animationFrameId); 
    track('game_round_ended', { reason:'manual_end' });
    clearArena();
  }

  startBtn.onclick = startGame;
  endBtn.onclick   = endGame;

  // تحديث واجهة الهدف عند البداية
  updateGoalUI();
</script>
</body>
</html>
